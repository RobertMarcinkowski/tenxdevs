<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Preferences - VibeTravels</title>
    <script th:if="${!useMockAuth}" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script th:if="${useMockAuth}" src="/js/mock-auth.js"></script>
    <style>
        .env-ribbon {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: var(--ribbon-color);
            color: #000;
            text-align: center;
            padding: 8px 10px;
            font-weight: bold;
            font-size: 14px;
            z-index: 9999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        body.with-ribbon {
            padding-top: 50px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .form-section {
            margin-bottom: 30px;
        }
        .form-section h3 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #5a6268;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        .success {
            color: #28a745;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .button-group {
            margin-top: 30px;
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body th:classappend="${environmentType != null ? 'with-ribbon' : ''}">
    <div th:if="${environmentType != null}" class="env-ribbon" th:style="'--ribbon-color: ' + ${ribbonColor}">
        <span th:text="${environmentType}">ENVIRONMENT</span>
    </div>

    <div id="loading" class="container loading">
        <h2>Loading preferences...</h2>
    </div>

    <div id="error-container" class="container" style="display: none;">
        <div class="error" style="display: block;">
            <strong>Authentication Required</strong>
            <p>You need to log in to access this page.</p>
            <p><a href="/login">Go to Login</a></p>
        </div>
    </div>

    <div id="content" class="container" style="display: none;">
        <h1>Travel Preferences</h1>
        <p class="subtitle">Customize your travel preferences to get personalized trip recommendations</p>

        <div id="error-message" class="error"></div>
        <div id="success-message" class="success"></div>

        <form id="preferences-form">
            <div class="form-section">
                <h3>Budget</h3>
                <div class="form-group">
                    <label for="budget">How much do you typically want to spend?</label>
                    <select id="budget" name="budget">
                        <option value="">Select your budget preference</option>
                    </select>
                </div>
            </div>

            <div class="form-section">
                <h3>Travel Pace</h3>
                <div class="form-group">
                    <label for="pace">What pace do you prefer when traveling?</label>
                    <select id="pace" name="pace">
                        <option value="">Select your preferred pace</option>
                    </select>
                </div>
            </div>

            <div class="form-section">
                <h3>Interests</h3>
                <div class="form-group">
                    <label>What are your travel interests? (Select all that apply)</label>
                    <div id="interests" class="checkbox-group"></div>
                </div>
            </div>

            <div class="form-section">
                <h3>Accommodation Style</h3>
                <div class="form-group">
                    <label for="accommodationStyle">What type of accommodation do you prefer?</label>
                    <select id="accommodationStyle" name="accommodationStyle">
                        <option value="">Select accommodation style</option>
                    </select>
                </div>
            </div>

            <div class="form-section">
                <h3>Transportation</h3>
                <div class="form-group">
                    <label>How do you prefer to travel? (Select all that apply)</label>
                    <div id="transport" class="checkbox-group"></div>
                </div>
            </div>

            <div class="form-section">
                <h3>Food Preferences</h3>
                <div class="form-group">
                    <label>What are your food preferences? (Select all that apply)</label>
                    <div id="foodPreferences" class="checkbox-group"></div>
                </div>
            </div>

            <div class="form-section">
                <h3>Season</h3>
                <div class="form-group">
                    <label for="season">When do you prefer to travel?</label>
                    <select id="season" name="season">
                        <option value="">Select preferred season</option>
                    </select>
                </div>
            </div>

            <div class="button-group">
                <button type="submit" id="save-button">Save Preferences</button>
                <button type="button" class="btn-secondary" onclick="window.location.href='/app'">Back to App</button>
            </div>
        </form>
    </div>

    <script th:inline="javascript">
        const USE_MOCK_AUTH = /*[[${useMockAuth}]]*/ false;

        let authClient;
        if (USE_MOCK_AUTH) {
            authClient = window.mockSupabaseClient;
        } else {
            const SUPABASE_URL = /*[[${supabaseUrl}]]*/ 'http://localhost:54321';
            const SUPABASE_ANON_KEY = /*[[${supabaseAnonKey}]]*/ '';
            const { createClient } = supabase;
            authClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        let accessToken = null;

        async function init() {
            const loadingDiv = document.getElementById('loading');
            const errorContainer = document.getElementById('error-container');
            const contentDiv = document.getElementById('content');

            try {
                const { data: { session }, error } = await authClient.auth.getSession();

                if (error || !session) {
                    loadingDiv.style.display = 'none';
                    errorContainer.style.display = 'block';
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    return;
                }

                accessToken = session.access_token;

                // Load preference options and existing preferences
                await loadPreferenceOptions();
                await loadExistingPreferences();

                loadingDiv.style.display = 'none';
                contentDiv.style.display = 'block';

            } catch (err) {
                console.error('Initialization failed:', err);
                loadingDiv.style.display = 'none';
                errorContainer.style.display = 'block';
            }
        }

        async function loadPreferenceOptions() {
            try {
                const response = await fetch('/api/preferences/options', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load options');

                const options = await response.json();

                // Populate single-choice selects
                populateSelect('budget', options.budget);
                populateSelect('pace', options.pace);
                populateSelect('accommodationStyle', options.accommodationStyle);
                populateSelect('season', options.season);

                // Populate multi-choice checkboxes
                populateCheckboxes('interests', options.interests);
                populateCheckboxes('transport', options.transport);
                populateCheckboxes('foodPreferences', options.foodPreferences);

            } catch (error) {
                console.error('Error loading options:', error);
                showError('Failed to load preference options');
            }
        }

        async function loadExistingPreferences() {
            try {
                const response = await fetch('/api/preferences', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.status === 404) {
                    // No preferences saved yet, that's okay
                    return;
                }

                if (!response.ok) throw new Error('Failed to load preferences');

                const prefs = await response.json();

                // Set single-choice values
                if (prefs.budget) document.getElementById('budget').value = prefs.budget;
                if (prefs.pace) document.getElementById('pace').value = prefs.pace;
                if (prefs.accommodationStyle) document.getElementById('accommodationStyle').value = prefs.accommodationStyle;
                if (prefs.season) document.getElementById('season').value = prefs.season;

                // Set multi-choice checkboxes
                if (prefs.interests) {
                    prefs.interests.forEach(interest => {
                        const checkbox = document.querySelector(`input[name="interests"][value="${interest}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                if (prefs.transport) {
                    prefs.transport.forEach(t => {
                        const checkbox = document.querySelector(`input[name="transport"][value="${t}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                if (prefs.foodPreferences) {
                    prefs.foodPreferences.forEach(food => {
                        const checkbox = document.querySelector(`input[name="foodPreferences"][value="${food}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

            } catch (error) {
                console.error('Error loading existing preferences:', error);
            }
        }

        function populateSelect(elementId, options) {
            const select = document.getElementById(elementId);
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.label;
                select.appendChild(optionElement);
            });
        }

        function populateCheckboxes(containerId, options) {
            const container = document.getElementById(containerId);
            options.forEach(option => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `${containerId}-${option.value}`;
                checkbox.name = containerId;
                checkbox.value = option.value;

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = option.label;
                label.style.fontWeight = 'normal';
                label.style.marginBottom = '0';

                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        function getCheckedValues(name) {
            const checkboxes = document.querySelectorAll(`input[name="${name}"]:checked`);
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }

        document.getElementById('preferences-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const saveButton = document.getElementById('save-button');
            saveButton.disabled = true;

            const preferences = {
                budget: document.getElementById('budget').value || null,
                pace: document.getElementById('pace').value || null,
                interests: getCheckedValues('interests'),
                accommodationStyle: document.getElementById('accommodationStyle').value || null,
                transport: getCheckedValues('transport'),
                foodPreferences: getCheckedValues('foodPreferences'),
                season: document.getElementById('season').value || null
            };

            try {
                const response = await fetch('/api/preferences', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(preferences)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showSuccess('Preferences saved successfully! Redirecting...');
                    setTimeout(() => {
                        window.location.href = '/app';
                    }, 1500);
                } else {
                    throw new Error(result.message || 'Failed to save preferences');
                }

            } catch (error) {
                console.error('Error saving preferences:', error);
                showError(error.message || 'Failed to save preferences');
            } finally {
                saveButton.disabled = false;
            }
        });

        init();
    </script>
</body>
</html>

name: Prepare Release

run-name: ${{ github.actor }} is preparing a release

on:
  workflow_dispatch:
    inputs:
      version-bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'

env:
  REPOSITORY_NAME: tenxdevs

jobs:
  create-release-pr:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check out repository code
        uses: actions/checkout@v5
        with:
          ref: develop

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Calculate new version
        id: version
        run: |
          # Get current version from build.gradle.kts
          CURRENT_VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')
          echo "Current version: $CURRENT_VERSION"

          # Remove -SNAPSHOT if present
          BASE_VERSION="${CURRENT_VERSION%-SNAPSHOT}"

          # Split version into components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"

          # Increment based on user input
          case "${{ github.event.inputs.version-bump }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          RELEASE_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "Release version: $RELEASE_VERSION"
          echo "release-version=$RELEASE_VERSION" >> $GITHUB_OUTPUT

      - name: Create release branch
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git checkout -b release/v${{ steps.version.outputs.release-version }}

      - name: Update version in build.gradle.kts
        run: |
          sed -i 's/^version = ".*"/version = "${{ steps.version.outputs.release-version }}"/' build.gradle.kts
          cat build.gradle.kts | grep "^version"

      - name: Commit version change
        run: |
          git add build.gradle.kts
          git commit -m "chore: prepare release ${{ steps.version.outputs.release-version }}"
          git push origin release/v${{ steps.version.outputs.release-version }}

      - name: Create Pull Request to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base main \
            --head release/v${{ steps.version.outputs.release-version }} \
            --title "Release v${{ steps.version.outputs.release-version }}" \
            --body "## Release v${{ steps.version.outputs.release-version }}

          This PR prepares the release by removing -SNAPSHOT from the version.

          ### Changes
          - Updated version in build.gradle.kts to \`${{ steps.version.outputs.release-version }}\`

          ### Checklist
          - [ ] Review CHANGELOG (if applicable)
          - [ ] Verify all tests pass
          - [ ] Confirm version number is correct

          ### After Merging
          After this PR is merged:
          1. Production deployment will automatically trigger
          2. Version will be automatically bumped to the next SNAPSHOT version
          3. A new PR will be created to merge the version bump back to develop

          ---
          _This PR was automatically created by the Prepare Release workflow_"

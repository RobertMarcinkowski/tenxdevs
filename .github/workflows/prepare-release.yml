name: Prepare Release

run-name: ${{ github.actor }} is preparing a release

on:
  workflow_dispatch:
    inputs:
      release-version:
        description: 'Release version number (e.g., 1.0.0, 2.1.3). Leave empty to use current version without -SNAPSHOT'
        required: false
        type: string

env:
  REPOSITORY_NAME: tenxdevs

jobs:
  create-release-pr:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check out repository code
        uses: actions/checkout@v5
        with:
          ref: develop

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Validate and set release version
        id: version
        run: |
          # Get current version from build.gradle.kts
          CURRENT_VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')
          echo "Current version: $CURRENT_VERSION"

          # Remove -SNAPSHOT from current version
          CURRENT_BASE="${CURRENT_VERSION%-SNAPSHOT}"
          echo "Current base version: $CURRENT_BASE"

          # Get user-provided release version or use current base version
          INPUT_VERSION="${{ github.event.inputs.release-version }}"

          if [ -z "$INPUT_VERSION" ]; then
            # No input provided, use current version without -SNAPSHOT
            RELEASE_VERSION="$CURRENT_BASE"
            echo "No version provided, using current base version: $RELEASE_VERSION"
          else
            # User provided a version, validate it
            RELEASE_VERSION="$INPUT_VERSION"
            echo "Requested release version: $RELEASE_VERSION"

            # Validate version format (must be X.Y.Z where X, Y, Z are numbers)
            if ! [[ "$RELEASE_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "Error: Invalid version format. Must be in format X.Y.Z (e.g., 1.0.0, 2.1.3)"
              exit 1
            fi

            # Split versions for comparison
            IFS='.' read -r CURR_MAJOR CURR_MINOR CURR_PATCH <<< "$CURRENT_BASE"
            IFS='.' read -r NEW_MAJOR NEW_MINOR NEW_PATCH <<< "$RELEASE_VERSION"

            # Compare versions and show warnings
            if [ "$NEW_MAJOR" -lt "$CURR_MAJOR" ]; then
              echo "Warning: New major version ($NEW_MAJOR) is less than current ($CURR_MAJOR)"
            elif [ "$NEW_MAJOR" -eq "$CURR_MAJOR" ] && [ "$NEW_MINOR" -lt "$CURR_MINOR" ]; then
              echo "Warning: New minor version ($NEW_MINOR) is less than current ($CURR_MINOR)"
            elif [ "$NEW_MAJOR" -eq "$CURR_MAJOR" ] && [ "$NEW_MINOR" -eq "$CURR_MINOR" ] && [ "$NEW_PATCH" -lt "$CURR_PATCH" ]; then
              echo "Warning: New patch version ($NEW_PATCH) is less than current ($CURR_PATCH)"
            fi
          fi

          echo "Release version: $RELEASE_VERSION"
          echo "release-version=$RELEASE_VERSION" >> $GITHUB_OUTPUT

      - name: Create release branch
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git checkout -b release/v${{ steps.version.outputs.release-version }}

      - name: Update version in build.gradle.kts
        run: |
          sed -i 's/^version = ".*"/version = "${{ steps.version.outputs.release-version }}"/' build.gradle.kts
          cat build.gradle.kts | grep "^version"

      - name: Commit version change
        run: |
          git add build.gradle.kts
          git commit -m "chore: prepare release ${{ steps.version.outputs.release-version }}"
          git push origin release/v${{ steps.version.outputs.release-version }}

      - name: Create Pull Request to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base main \
            --head release/v${{ steps.version.outputs.release-version }} \
            --title "Release v${{ steps.version.outputs.release-version }}" \
            --body "## Release v${{ steps.version.outputs.release-version }}

          This PR prepares the release by removing -SNAPSHOT from the version.

          ### Changes
          - Updated version in build.gradle.kts to \`${{ steps.version.outputs.release-version }}\`

          ### Checklist
          - [ ] Review CHANGELOG (if applicable)
          - [ ] Verify all tests pass
          - [ ] Confirm version number is correct

          ### After Merging
          After this PR is merged:
          1. Production deployment will automatically trigger
          2. Version will be automatically bumped to the next SNAPSHOT version
          3. A new PR will be created to merge the version bump back to develop

          ---
          _This PR was automatically created by the Prepare Release workflow_"
